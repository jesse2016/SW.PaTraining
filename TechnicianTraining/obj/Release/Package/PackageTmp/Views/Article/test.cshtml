@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>断点上传</title>
    <script src="~/Content/webdoc/js/jquery-1.10.2.min.js"></script>
</head>
<body>
    <input id="myFile" type="file">
    <button onclick="Start()">上传</button>
    <button onclick="Pause()">暂停</button>
    <button onclick="Continue()">继续</button>
    <label>当前进度：<span id="progress"></span></label>
    <script>
        var count = 1;
        var uploadId = '';
        var index = 0;
        var blockCount = 0;
        var pause = false; //暂停

        function Start() {
            count = 1;
            index = 0;
            uploadId = '';
            Upload();
        }

        function Upload() {
            var files = document.getElementById('myFile').files;
            if (files.length < 1) {
                alert('请选择文件~');
                return;
            }
            var file = files[0];
            var totalSize = file.size;//文件大小
            var blockSize = 1024 * 1024 * 2;//块大小2M
            blockCount = Math.ceil(totalSize / blockSize);//总块数
            console.log("文件大小：" + totalSize);
            console.log("总块数："+blockCount);

            //创建FormData对象
            var formData = new FormData();
            formData.append('fileName', file.name);//文件名
            formData.append('total', blockCount);//总块数
            formData.append('index', index);//当前上传的块下标
            formData.append('uploadId', uploadId);//上传编号
            formData.append('data', null);

            UploadPost(file, formData, totalSize, blockCount, blockSize);
        }

        function UploadPost(file, formData, totalSize, blockCount, blockSize) {
            if (pause) {
                return; //暂停
            }
            try {
                var start = index * blockSize;
                var end = Math.min(totalSize, start + blockSize);
                console.log(start + " - " + end + " - " + count);
                count++;
                var block = file.slice(start, end);
                formData.set('data', block);
                formData.set('index', index);
                formData.set('uploadId', uploadId);

                $.ajax({
                    url: '/Article/Upload',
                    type: 'post',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        //console.log(res);
                        block = null;
                        if (res.Code === 1) {
                            if (index === 0) {
                                uploadId = res.UploadID;
                            }
                            index++;
                            var percent = (index / blockCount * 100).toFixed(2) + '%';
                            console.log(percent);
                            $('#progress').text(percent);
                            if (index < blockCount) {
                                UploadPost(file, formData, totalSize, blockCount, blockSize);
                            }
                        }
                        else {
                            alert(res.Msg);
                        }
                    }
                });
            } catch (e) {
                alert(e);
            }
        }
        ///暂停
        function Pause() {
            pause = true;
        }
        //继续
        function Continue() {
            if (index + 1 < blockCount) {
                pause = false;
                Upload();
            }
            else {
                alert("文件已上传完成");
            }
        }
    </script>
</body>
</html>